<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - My Room Match</title>
  <link rel="stylesheet" href="./CSS/admin-panel.css">
  <link rel="apple-touch-icon" sizes="180x180" href="./favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon_io/favicon-16x16.png">
  <link rel="manifest" href="./favicon_io/site.webmanifest">
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore-compat.js"></script>

  <script>

    const firebaseConfig = {
  apiKey: "AIzaSyAWHOjEiQ3_BOALQokf9KSWkzariT0WARs",
  authDomain: "my-room-match.firebaseapp.com",
  projectId: "my-room-match",
  storageBucket: "my-room-match.firebasestorage.app",
  messagingSenderId: "29511216593",
  appId: "1:29511216593:web:56d143598fb32aab8944f0",
  measurementId: "G-PV616XMSRT"
};
    
firebase.initializeApp(firebaseConfig);
   
const db = firebase.firestore();

  </script>

</head>
<body>
  <header>
    <h1>My Room Match - Admin Dashboard</h1>
  </header>

  <main>
    <section id="room-section">
      <h2> Available Room Management</h2>
      <form id="roomForm" class="room-form">

        <label>Room ID <input type="text" id="roomId" required></label>
        <label>Type
          <select id="roomType">
            <option value="single">Single</option>
            <option value="twin">Twin</option>
            <option value="triple">Triple</option>
          </select>
        </label>
        <label>Capacity <input type="number" id="roomCapacity" required></label>
        <label>Floor <input type="text" id="roomFloor"></label>
        <label>Location <input type="text" id="roomLocation"></label>
        <label>Photo <input type="file" id="roomPhoto" accept="image/*" /></label>
        <label for="roomPrice">Price (INR):</label>
        <input type="number" id="roomPrice" placeholder="Enter price..." required />

        <button type="submit">Add/Update Room</button>
      </form>
    </section>

    <section id="user-section">
      <h2> Registered Users</h2>
      <div id="userTable"></div>
    </section>
    <section id="match-section">
      <h2> Matched Users</h2>
      <div id="matchList"></div>
    </section>
  </main>

  <script>
    firebase.auth().onAuthStateChanged((user) => {
  if (!user || user.email !== "prakashmohit21x@gmail.com") {
    alert("Access Denied ðŸš«");
    window.location.href = "/admin-login.html";
    return;
  }

  // âœ… Admin is logged in â€” safe to proceed
  document.getElementById("roomForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const roomId = document.getElementById("roomId").value;
    const roomPhoto = document.getElementById("roomPhoto").files[0];
    let photoURL = "";

    if (roomPhoto) {
      const formData = new FormData();
      formData.append("file", roomPhoto);
      formData.append("upload_preset", "unsigned_preset");

      const response = await fetch("https://api.cloudinary.com/v1_1/dexoyiip5/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      photoURL = data.secure_url;
    }

    const roomData = {
      type: document.getElementById("roomType").value.toLowerCase(),
      capacity: parseInt(document.getElementById("roomCapacity").value),
      floor: document.getElementById("roomFloor").value,
      location: document.getElementById("roomLocation").value,
      price: parseFloat(document.getElementById("roomPrice").value),
      photo: photoURL,
      status: "available",
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection("availableRooms").doc(roomId).set(roomData, { merge: true });
    alert("Room info saved âœ…");
  });
});

// Load Registered Users
async function loadRegisteredUsers() {
  try {
    const userSnapshot = await db.collection("users").get();
    const container = document.getElementById("userTable");
    

    userSnapshot.forEach(doc => {
      const data = doc.data();
      const userCard = document.createElement("div");
      userCard.classList.add("user-card");

      userCard.innerHTML = `
        <img src="${data.photoURL || './assets/default-user.png'}" alt="User Photo" />
        <div>
          <h4>${data.name || 'Unnamed'}</h4>
          <p>Email: ${data.email || 'No email'}</p>
          <p>Phone: ${data.phone || 'N/A'}</p>
          <p>Address: ${data.address || 'N/A'}</p>
        </div>
      `;

      container.appendChild(userCard);
    });
  } catch (error) {
    console.error("Error loading users:", error);
  }
}


// Load Matched Users with Assigned Rooms
async function loadMatches() {
  try {
    const matchSnapshot = await db.collection("matches").get();
    const matchList = document.getElementById("matchList");
    matchList.innerHTML = ""; // Clear previous content

    matchSnapshot.forEach(doc => {
      const data = doc.data();
      const best = data.bestMatch || {};
      const assignedRoom = data.assignedRoom || "Not Assigned";

      const div = document.createElement("div");
      div.innerHTML = `
        <p><strong>User ID:</strong> ${doc.id} <br>
        Matched with: <strong>${best.name || 'N/A'}</strong> <br>
        Room: <strong>${assignedRoom}</strong></p>
        <hr>
      `;

      matchList.appendChild(div);
    });
  } catch (error) {
    console.error("Error loading matches:", error);
  }
}


// Load Available Rooms
async function loadAvailableRooms() {
  const snapshot = await db.collection("availableRooms").get();
  const section = document.createElement("section");
  section.innerHTML = "<h2> Available Rooms</h2>";

  snapshot.forEach(doc => {
    const data = doc.data();
    const div = document.createElement("div");
    div.classList.add("room-card");
    div.innerHTML = `
      <img src="${data.photo}" alt="Room Image" />
      <div>
        <h4>${doc.id}</h4>
        <p>Type: ${data.type}</p>
        <p>Capacity: ${data.capacity}</p>
        <p>Floor: ${data.floor}</p>
        <p>Location: ${data.location}</p>
        <p>Price: â‚¹${data.price}</p>
      </div>
    `;
    section.appendChild(div);
  });

  document.querySelector("main").appendChild(section);
}

// Load everything once admin is authenticated
firebase.auth().onAuthStateChanged((user) => {
  if (!user || user.email !== "prakashmohit21x@gmail.com") {
    alert("Access Denied ðŸš«");
    window.location.href = "/admin-login.html";
    return;
  }

  // Load content
  loadRegisteredUsers();
  loadMatches();
  loadAvailableRooms();
});


  </script>
</body>
</html>
